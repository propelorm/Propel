= Delegate Behavior =

[[PageOutline]]

The `delegate` behavior allows a model to delegate methods to one of its relationships. This helps to isolate logic in a dedicated model, or to simulate [http://martinfowler.com/eaaCatalog/classTableInheritance.html class table inheritance].

== Basic Usage ==

In the `schema.xml`, use the `<behavior>` tag to add the `delegate` behavior to a table. In the `<parameters>` tag, specify the table that the current table delegates to as the `to` parameter:

{{{
#!xml
<table name="account">
  <column name="id" required="true" primaryKey="true" autoIncrement="true" type="INTEGER" />
  <column name="login" type="VARCHAR" required="true" />
  <column name="password" type="VARCHAR" required="true" />
  <behavior name="delegate">
    <parameter name="to" value="profile" />
  </behavior>
</table>
<table name="profile">
  <column name="email" type="VARCHAR" />
  <column name="telephone" type="VARCHAR" />
</table>
}}}

Rebuild your model, insert the table creation sql again, and you're ready to go. The delegate `profile` table is now related to the `account` table using a one-to-one relationship. That means that the behavior creates a foreign primary key in the `profile` table. In fact, everything happens as if you had defined the following schema:

{{{
#!xml
<table name="account">
  <column name="id" required="true" primaryKey="true" autoIncrement="true" type="INTEGER" />
  <column name="login" type="VARCHAR" required="true" />
  <column name="password" type="VARCHAR" required="true" />
</table>
<table name="profile">
  <column name="id" required="true" primaryKey="true" type="INTEGER" />
  <column name="email" type="VARCHAR" />
  <column name="telephone" type="VARCHAR" />
  <foreign-key foreignTable="account" onDelete="setnull" onUpdate="cascade">
    <reference local="id" foreign="id" />
  </foreign-key>
</table>
}}}

**Tip**: If the delegate table already has a foreign key to the main table, the behavior doesn't recreate it. It allows you to have full control over the relatiosnhip between the two tables.

In addition, the !ActiveRecord `Account` class now provides integrated delegation capabilities. That means that it offers to handle directly the columns of the `Profile` model, while in reality it finds or create a related `Profile` object and calls the methods on this delegate:

{{{
#!php
<?php
$account = new Account();
$account->setLogin('francois');
$account->setPassword('S€cr3t');

// Fill the profile via delegation
$account->setEmail('francois@example.com');
$account->setTelephone('202-555-9355');
// same as
$profile = new Profile();
$profile->setEmail('francois@example.com');
$profile->setTelephone('202-555-9355');
$account->setProfile($profile);

// save the account and its profile
$account->save();

// retrieve delegated data directly from the main object
echo $account->getEmail(); // francois@example.com
}}}

Getter an setter methods for delegate columns don't exist on the main object ; the delegation is handled by the magical `__call()` method. Therefore, the delegation also works for custom methods in the delegate table.

{{{
#!php
<?php
class Profile extends BaseProfile
{
  public function setFakeEmail()
  {
    $n = rand(10e16, 10e20);
    $fakeEmail = base_convert($n, 10, 36) . '@example.com';
    $this->setEmail($fakeEmail);
  }
}

$account = new Account();
$account->setFakeEmail(); // delegates to Profile::setFakeEmail()
}}}

== Delegating To Several Tables ==

Contrary to class table inheritance, delegation allows to delegate to several tables. Just separate the name of the delegate tables by commas in the `to` parameter of the `delegate` behavior tag in your schema to delegate to several tables:

{{{
#!xml
<table name="account">
  <column name="id" required="true" primaryKey="true" autoIncrement="true" type="INTEGER" />
  <column name="login" type="VARCHAR" required="true" />
  <column name="password" type="VARCHAR" required="true" />
  <behavior name="delegate">
    <parameter name="to" value="profile, preference" />
  </behavior>
</table>
<table name="profile">
  <column name="email" type="VARCHAR" />
  <column name="telephone" type="VARCHAR" />
</table>
<table name="preference">
  <column name="preferred_color" type="VARCHAR" />
  <column name="max_size" type="INTEGER" />
</table>
}}}

Now the `Account` class has two delegates, that can be addressed seamlessly:

{{{
#!php
<?php
$account = new Account();
$account->setLogin('francois');
$account->setPassword('S€cr3t');

// Fill the profile via delegation
$account->setEmail('francois@example.com');
$account->setTelephone('202-555-9355');
// Fill the preference via delegation
$account->setPreferredColor('orange');
$account->setMaxSize('200');

// save the account and its profile and its preference
$account->save();
}}}

On the other hand, it is not possible to cascade delegation to yet another model. So even if the `profile` table delegates to another `detail` table, the methods of the `Detail` model won't be accessibe to the `Profile` objects.

**Tip**: Table delegation can be used to mimic [http://martinfowler.com/eaaCatalog/classTableInheritance.html Class Table Inheritance]. See how in the [wiki:Documentation/1.6/Inheritance inheritance chapter].

== Parameters ==

the behavior tales only one parameter, the list of delegate tables:

{{{
#!xml
<table name="account">
  <column name="id" required="true" primaryKey="true" autoIncrement="true" type="INTEGER" />
  <column name="login" type="VARCHAR" required="true" />
  <column name="password" type="VARCHAR" required="true" />
  <behavior name="delegate">
    <parameter name="to" value="profile, preference" />
  </behavior>
</table>
}}}

Note that the delegate tables must exist, but they don't need to share a relationship with the main table (in which case the behavior creates that relationship).